<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Админка - Вход</title>
    <meta name="robots" content="noindex, nofollow">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['-apple-system', 'BlinkMacSystemFont', 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', 'Helvetica', 'Arial', 'sans-serif'],
                    },
                    colors: {
                        'apple-blue': '#007AFF',
                        'apple-gray': {
                            50: '#F5F5F7',
                            100: '#F2F2F7',
                            200: '#E5E5EA',
                            300: '#D1D1D6',
                            400: '#C7C7CC',
                            500: '#AEAEB2',
                            600: '#8E8E93',
                            700: '#636366',
                            800: '#48484A',
                            900: '#1C1C1E',
                        },
                        'dark': {
                            bg: '#000000',
                            'bg-secondary': '#1C1C1E',
                            'bg-tertiary': '#2C2C2E',
                            border: '#48484A',
                            text: '#FFFFFF',
                            'text-secondary': '#AEAEB2'
                        }
                    },
                    boxShadow: {
                        'apple': '0 4px 16px rgba(0, 0, 0, 0.08)',
                        'apple-sm': '0 2px 8px rgba(0, 0, 0, 0.04)',
                    },
                    borderRadius: {
                        'apple': '12px',
                        'apple-lg': '20px',
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            body {
                overflow: hidden;
                position: fixed;
                width: 100%;
                height: 100%;
            }
        }
    </style>
</head>
<body class="bg-apple-gray-50 dark:bg-dark-bg antialiased">
    <div class="fixed inset-0 flex items-center justify-center p-4 overflow-y-auto">
        <div class="w-full max-w-sm">
            <div class="text-center mb-10">
                <h1 class="text-4xl font-semibold text-apple-gray-900 dark:text-dark-text mb-3 tracking-tight">Админка</h1>
                <p class="text-base text-apple-gray-600 dark:text-dark-text-secondary">Введите пароль для доступа</p>
            </div>

            <div id="errorMessage" class="bg-red-50 border border-red-300 text-red-700 px-5 py-4 rounded-apple mb-5 hidden text-sm shadow-apple-sm">
                Неверный пароль
            </div>

            <form id="loginForm">
                <div class="mb-5">
                    <input
                        type="password"
                        id="passwordInput"
                        required
                        autocomplete="current-password"
                        placeholder="Пароль"
                        class="w-full px-5 py-4 bg-white dark:bg-dark-bg-secondary border border-apple-gray-300 dark:border-dark-border dark:text-dark-text rounded-apple focus:ring-2 focus:ring-apple-blue focus:border-transparent outline-none transition text-base shadow-apple-sm"
                    >
                </div>

                <button
                    type="submit"
                    id="submitBtn"
                    class="w-full bg-apple-blue text-white font-medium py-4 rounded-apple hover:opacity-90 active:opacity-80 transition text-base shadow-apple-sm"
                >
                    Войти
                </button>
            </form>

            <p class="text-center text-sm text-apple-gray-600 dark:text-dark-text-secondary mt-6">
                Secure login • Админка v2.0
            </p>
        </div>
    </div>

    <script src="theme.js"></script>
    <script src="auth.js"></script>
    <script>
        const loginForm = document.getElementById('loginForm');
        const passwordInput = document.getElementById('passwordInput');
        const submitBtn = document.getElementById('submitBtn');
        const errorMessage = document.getElementById('errorMessage');

        // If already logged in, redirect to saved URL or dashboard
        if (auth.isAuthenticated) {
            const returnUrl = sessionStorage.getItem('returnUrl');
            if (returnUrl) {
                sessionStorage.removeItem('returnUrl');
                window.location.href = returnUrl;
            } else {
                window.location.href = `${auth.constructor.API_BASE || (window.location.pathname.startsWith('/support') ? '/support' : '')}/dashboard.html`;
            }
        }

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            errorMessage.classList.add('hidden');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Проверка...';

            const password = passwordInput.value;

            try {
                const isValid = await auth.verifyPassword(password);

                if (isValid) {
                    // Redirect to saved URL or dashboard
                    const returnUrl = sessionStorage.getItem('returnUrl');
                    if (returnUrl) {
                        sessionStorage.removeItem('returnUrl');
                        window.location.href = returnUrl;
                    } else {
                        window.location.href = `${auth.constructor.API_BASE || (window.location.pathname.startsWith('/support') ? '/support' : '')}/dashboard.html`;
                    }
                } else {
                    errorMessage.textContent = 'Неверный пароль';
                    errorMessage.classList.remove('hidden');
                    passwordInput.value = '';
                    passwordInput.focus();
                }
            } catch (error) {
                console.error('Login error:', error);
                // Display the error message from the exception
                errorMessage.textContent = error.message || 'Ошибка подключения к серверу';
                errorMessage.classList.remove('hidden');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Войти';
            }
        });

        // Focus on password input on load
        passwordInput.focus();
    </script>
</body>
</html>
